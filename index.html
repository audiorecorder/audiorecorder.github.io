<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">			
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Cloud Audio Recorder</title>
<meta name="description" content="Cloud Audio Recorder is a fun, simple and easy to use audio & voice recorder. This audio recorder is a free recorder that can capture any sound made by your PC, or those that come via a microphone. You can also save the audio file to your computer or Google Drive directly.">
<meta name="keywords" content="online audio recorder, cloud audio recorder, audio recorder for google drive, audio recorder mp3, audio recorder wav">

<meta property="og:title" content="Cloud Audio Recorder"> 
<meta property="og:description" content="Cloud Audio Recorder is a fun, simple and easy to use audio & voice recorder. This audio recorder is a free recorder that can capture any sound made by your PC, or those that come via a microphone. You can also save the audio file to your computer or Google Drive directly.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://googledrive.com/host/0BxpPVDYc2qtZflhFZy0wcFRuLUZfdk9JSUJXT2d0MjQ1aWFoY2VFUUU2b0p5S0themNqelE/">
<meta property="og:image" content="https://googledrive.com/host/0BxpPVDYc2qtZflhFZy0wcFRuLUZfdk9JSUJXT2d0MjQ1aWFoY2VFUUU2b0p5S0themNqelE/img/logo128.png">

<link rel="shortcut icon" href="./favicon.ico">

<script src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
<script src="js/common.js"></script>

<style type="text/css">
body,table,td{
	font-size:14px;
    font-family: Verdana, Arial, Helvetica, sans-serif; /*Trebuchet MS, Tahoma, Verdana*/
}
button{
	font-size:15px;
}
body{
	background: #e3e3e3;
}
A:link    {color:#0860A8;text-decoration:none;}
A:visited {color:#0860A8;text-decoration:none;}
A:active  {color:#0860A8;text-decoration:underline;}
A:hover  {color;#0860A8;text-decoration:underline;}
.processed{
	color:#8A0808;
}
.welcome{
	color:#45616D;
}
        .stretcher{
            box-sizing: border-box;
            display: inline-block;
        }

        .stretcher.w100p
        {
            margin: 1% 2%;
            width: 96%;
        }

        .stretcher.w50p
        {
            margin: 1% 2%;
            width: 46%;
        }

        .stretcher.w33p
        {
            margin: 1% 2%;
            width: 29%;
        }
        .panel
        {
            margin: 10px 0px 20px;
        }

        .panel table
        {
            width: 100%;
            border-spacing: 0;
            border-collapse: collapse;
            text-align: center;
        }

        #view-hex
        {
            width: 100%;
            font-family: Courier;
        }
        .label
        {
            background-color: #EFEFEF;
            padding: 5px;
            color: #000;
            text-shadow: none;
        }
        .status
        {
            width: 60px;
            padding: 0 10px;
            display: inline-block;
        }

        /* spinner */
        .spinner 
        {
            /*position: fixed;
            right: 35px;
            top: 70px; */
            z-index: 1;
        }

        .spinner {
          margin: 5px auto;
          width: 50px;
          height: 30px;
          text-align: center;
          font-size: 10px;
        }

        .spinner > div {
          background-color: #aa2222;
          height: 100%;
          width: 6px;
          display: inline-block;
          
          -webkit-animation: stretchdelay 1.2s infinite ease-in-out;
          animation: stretchdelay 1.2s infinite ease-in-out;
        }

        .spinner .rect2 {
          -webkit-animation-delay: -1.1s;
          animation-delay: -1.1s;
        }

        .spinner .rect3 {
          -webkit-animation-delay: -1.0s;
          animation-delay: -1.0s;
        }

        .spinner .rect4 {
          -webkit-animation-delay: -0.9s;
          animation-delay: -0.9s;
        }

        .spinner .rect5 {
          -webkit-animation-delay: -0.8s;
          animation-delay: -0.8s;
        }

        @-webkit-keyframes stretchdelay {
          0%, 40%, 100% { -webkit-transform: scaleY(0.4) }  
          20% { -webkit-transform: scaleY(1.0) }
        }

        @keyframes stretchdelay {
          0%, 40%, 100% { 
            transform: scaleY(0.4);
            -webkit-transform: scaleY(0.4);
          } 20% {
            transform: scaleY(1.0);
            -webkit-transform: scaleY(1.0);
          }
        }
    </style>
</head>
<body>

<table align=center>
<tr><td height=5>
<tr><td>
	<a id="toptitle" href="https://googledrive.com/host/0BxpPVDYc2qtZflhFZy0wcFRuLUZfdk9JSUJXT2d0MjQ1aWFoY2VFUUU2b0p5S0themNqelE/" style="color:#aa2222" title="Go Home"><span id='i18n' style="font-size:30px;font-family:Verdana, Arial;">Cloud Audio Recorder</span></a>
<tr><td height=10>
</table>

<table width=750 align=center style="background: white;padding:5px 15px;-webkit-box-shadow: 0 0 10px #999;	-moz-box-shadow: 0 0 10px #999; box-shadow: 0 0 10px #999;">
<tr><td align=center>
<script type="text/javascript">
    google_ad_client = "ca-pub-1113541014872557";
    google_ad_slot = "5793224302";
    google_ad_width = 728;
    google_ad_height = 15;
</script>
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

<tr><td>
<table><tr>
<td><img src="img/logo65.png" width=60>
<td>
<td>Cloud Audio Recorder is a fun, simple and easy to use audio & voice recorder.
This audio recorder is a free recorder that can capture any sound made by your PC, or those that come via a microphone.<br>
You can save the recorded audio to the wav, mp3 format.
You can also save the audio file to your computer or Google Drive directly. Supports Chrome, IE10+, Firefox...
<br>
Note: You can record up to 7 minutes at a time. &nbsp;<a href="#" onclick="show_recorder();return false;" style="font-size:13px">Show/Hide Recoreder Setting</a>
</table>

<tr><td align=center>
<div id="downlink" style="margin-top:0px;width:600px"></div>
<div id="msg" style="display:;margin-top:2px;margin-bottom:3px;font-size:15px;color:green;width:600px;white-space:nowrap;overflow:hidden;border:0px solid red"></div>
  
	<center>      
    <div class="playcorder" id="idplaycorder" style="margin-top:7px">
		<div id="idloading">Loading Recorder... (Flash)</div>
        <div class="inner">		
            <div id="playcorder-placeholder"></div>
        </div>
    </div>
	</center>

<tr><td>
    <div id="panel" class="panel">
        <table>
            <tr>
                <td width="10%"><button id="mic-start" class="stretcher w100p" disabled="disabled">loading</button></td>
                <td width="5%"><img src="images/forward.png"></td>
                <td width="10%"><button id="mic-stop" class="stretcher w100p" disabled="disabled">Stopped</button></td>
                <td width="5%"><img src="images/forward.png"></td>
                <td width="35%">
                    <button id="mic-download-raw" class="stretcher w33p" disabled="disabled" style="display:none">download as raw data (js)</button>
					<!--<span class="stretcher w33p" style="text-align:center;">-&gt;</span>//-->
					<button id="mic-encode-wave" class="stretcher w33p" disabled="disabled" style="display:none">encode to wave (js)</button>

                    <button id="mic-download-wave" class="stretcher w100p" disabled="disabled">Download as wave (limit 50s)</button><br />
                    <button id="mic-download-mp3" class="stretcher w100p" disabled="disabled">Download as mp3</button><br />

                    <button id="mic-upload-wave" class="stretcher w100p" disabled="disabled" style="display:none">upload to ./test as wave file using plain post (as)</button>
                    <button id="mic-upload-mp3" class="stretcher w50p" disabled="disabled" style="display:none">upload to ./test as mp3 file using multipart(as)
                        </button><button
                         id="mic-upload-mp3-confirm" class="stretcher w50p" disabled="disabled" style="display:none">click to confirm upload</button>
                </td>
                <td width="5%"><img src="images/forward.png"></td>
                <td width="30%">
                    <button id="mic-buffer-play" class="stretcher w100p" disabled="disabled" style="display:none">Play shared buffer</button>
                    <button id="mic-buffer-play-as" class="stretcher w100p" disabled="disabled">Play recorded audio</button><br />
					<button id="mic-buffer-stop" class="stretcher w100p" disabled="disabled">Stop audio play</button><br />

                    <a href="javascript:void(0);" id="btn_save2_link"><button id="mic-buffer-extract" class="stretcher w100p" disabled="disabled">Save to Computer</button></a>
					<br>
					<button id="mic-buffer-drive" class="stretcher w100p" disabled="disabled" title="Save to Goolge Drive">Save to Goolge Drive</button>
					<div id="downinfo"></div>

                    <button id="mic-buffer-hexview" class="stretcher w100p" disabled="disabled" style="display:none">Display Hex</button>
                </td>
            </tr>
        </table>
    </div>
<tr><td>
	<table style="height:50px"><tr>
	<td>
		<div id="view-info">
			<span class="label">Muted:</span><span id="mic-muted" class="status muted"></span>
	        <span class="label">Volume:</span><span id="mic-volume" class="status volume"></span>
		    <span class="label">Recorded Duration:</span><span id="mic-duration" class="status duration"></span>			
		</div>
	    <span class="caption" style="display:none">Shared Buffer Hex View:</span>
		<div id="view-hex" style="display:none"></div>
	<td width=70>
	    <div id="spinner" class="spinner">
		    <div class="rect1"></div>
			<div class="rect2"></div>
	        <div class="rect3"></div>
		    <div class="rect4"></div>
			<div class="rect5"></div>
		</div>
	</table>
<tr><td>
	<div id="downlink2" style="margin-bottom:2px"></div>

<tr><td align=center>
<script type="text/javascript">
    google_ad_client = "ca-pub-1113541014872557";
    google_ad_slot = "4316491106";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<!---  
<div style="margin-top:7px">
<script type="text/javascript">
    google_ad_client = "ca-pub-1113541014872557";
    google_ad_slot = "4316491106";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
//--->
</table>


    <script type="text/javascript">

	var glastbloburl,gresp;
	window.URL=(window.URL || window.webkitURL);
	var gprogresstimer, gstarttime;
	var isworking;
var issafari=false;
var ua = navigator.userAgent.toLowerCase(); 
if (ua.indexOf('safari') != -1 && ua.indexOf('chrome') <0){ 
	issafari=true;
}

        function floatTo16BitPCM(output, offset, input){
            for (var i = 0; i < input.length; i++, offset+=2){
                var s = Math.max(-1, Math.min(1, input[i]));
                output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }
        function writeString(view, offset, string){
          for (var i = 0; i < string.length; i++){
            view.setUint8(offset + i, string.charCodeAt(i));
          }
        }		
		function converttime(s){
			s=parseInt(s);
			var min=Math.floor(s/60);
			var sec=parseInt(s % 60);					
			return fillnumber(min)+':'+fillnumber(sec);
		}
		function checkworking(){
			if(isworking){
				alert("It's working. Please try again later.");
				return true;
			}
		}
        function encodeWAV(config){
            var CHUNK_ID = 'RIFF';
            var TYPE = 'WAVE';
            var FORMAT_CHUNK_ID = 'fmt ';
            var DATA_CHUNK_ID = 'data' ;
            var BIT_LEN = 16;
            var BYTE_PER_SAMPLE = ( BIT_LEN / 8 );
            var cur = 0;

            var view = new DataView(new ArrayBuffer(44 + config.samples.length * 2));

            /* RIFF identifier */
            writeString(view, cur, CHUNK_ID);
            cur+= CHUNK_ID.length;

            /* file length */
            view.setUint32(cur, 36 + config.samples.length * BYTE_PER_SAMPLE, true);
            cur += 4;

            /* RIFF type */
            writeString(view, cur, TYPE);
            cur += TYPE.length;

            /* format chunk identifier */
            writeString(view, cur, FORMAT_CHUNK_ID);
            cur += FORMAT_CHUNK_ID.length;

            /* format chunk length */
            view.setUint32(cur, 16, true);
            cur += 4;

            /* sample format (raw) */
            view.setUint16(cur, 1, true);
            cur += 2;

            /* channel count */
            view.setUint16(cur, config.channels.length, true);
            cur += 2;

            /* sample rate */
            view.setUint32(cur, config.rate, true);
            cur += 4;

            /* byte rate (sample rate * block align) */
            view.setUint32(cur, config.rate * BYTE_PER_SAMPLE * config.channels.length, true);
            cur += 4;

            /* block align (channel count * bytes per sample) */
            view.setUint16(cur, config.channels.length * BYTE_PER_SAMPLE, true);
            cur += 2;

            /* bits per sample */
            view.setUint16(cur, BIT_LEN, true);
            cur += 2;

            /* data chunk identifier */
            writeString(view, cur, DATA_CHUNK_ID);
            cur += DATA_CHUNK_ID.length;

            /* data chunk length */
            view.setUint32( cur, config.samples.length * BYTE_PER_SAMPLE, true);
            cur += 4;

            floatTo16BitPCM(view, cur, config.samples);

            return view;
        }
		function show_recorder(){
			var a=_getid('idplaycorder');
			if(a.style.position=='absolute'){
				a.style.position='';
			}else{
				a.style.position='absolute';
				a.style.left='-9999px';
			}
		}
        
        (function(){
            // embed swf by using swfobject
            var ID_SWF = 'playcorder';
            var params = {};

            params.quality = "high";
            params.wmode = "transparent";
            params.allowscriptaccess = "always";
            params.allowfullscreen = "false";

            swfobject.embedSWF(
                "./dist/Playcorder.swf",
                "playcorder-placeholder", 
                "215", "140", 
                "11.9.0", "playerProductInstall.swf", 
                {}, params, {
                    id: ID_SWF,
                    name: ID_SWF
                }, 
                function( result ){
                    window.pc = result.ref;

                    var elSpinner = document.getElementById('spinner');				
					var elPlaycorder = document.getElementById('idplaycorder');

                    function showSpinner()
                    {
                        elSpinner.style.display = 'block';
                    }

                    function hideSpinner()
                    {
                        elSpinner.style.display = 'none';
                    }

                    pc.onloaded = function() {
						_getid('idloading').style.display='none';
                        hideSpinner();
                    };
                    
                    pc.onready = function(){
                        var curGUID;
                        var elMuted = document.getElementById('mic-muted');
                        var elVolume = document.getElementById('mic-volume');
                        var elDuration = document.getElementById('mic-duration');
                        var btnStart = document.getElementById('mic-start');
                        var btnStop = document.getElementById('mic-stop');
                        var btnDownloadRaw = document.getElementById('mic-download-raw');
                        var btnEncodeWave = document.getElementById('mic-encode-wave');
                        var btnDownloadWave = document.getElementById('mic-download-wave');
                        var btnDownloadMP3 = document.getElementById('mic-download-mp3');
                        var btnPlayBuffer = document.getElementById('mic-buffer-play');
                        var btnPlayBufferAs = document.getElementById('mic-buffer-play-as');
						var btnPlayStop = document.getElementById('mic-buffer-stop');						
                        var btnShowHex = document.getElementById('mic-buffer-hexview');
                        var btnUploadWave = document.getElementById('mic-upload-wave');
                        var btnUploadMP3 = document.getElementById('mic-upload-mp3');
                        var btnUploadMP3Confirm = document.getElementById('mic-upload-mp3-confirm');
                        var btnDownloadAsFile = document.getElementById('mic-buffer-extract');
						var btnDownloadAsDrive = document.getElementById('mic-buffer-drive');
                        var elViewHex = document.getElementById('view-hex');

                        var sharedArrayBuffer;
                        var sharedDownloadObject;
                        var sharedAudioContext;
                        
                        btnStart.removeAttribute('disabled');
                        btnStart.innerHTML = 'Start';
						elPlaycorder.style.position='absolute';
						elPlaycorder.style.left='-9999px';
                        
                        pc.recorder.initialize({
                            gain: 50, 
                            rate: 44, 
                            silence: 0, 
                            quality: 9,
                            type: 'local'
                        });

                        // detect recorder changes
                        pc.recorder.onchange = function(){
                            if ( pc.recorder_muted() ) {
                                elMuted.innerHTML = 'Yes';
                            }
                            else {
                                elMuted.innerHTML = 'No';
                            }
                        };

                        pc.recorder.onerror = function(){

                        };

                        pc.recorder.onstarted = function(evt) {
                            if ( evt.guid != curGUID) 
                            {
                                return;
                            }

							clearInterval(gprogresstimer);
							gstarttime=(new Date()).getTime();
							gprogresstimer=setInterval(function(){
								var s=(new Date()).getTime()-gstarttime;
								s=parseInt(s/1000);
								if(s>420){
									pc.recorder.stop();
									return;
								}
								elDuration.innerHTML=converttime(s);
							},1000);

                            btnStart.innerHTML = 'Started'
                            btnStart.setAttribute('disabled', 'disabled');

                            btnStop.innerHTML = 'Stop';
                            btnStop.removeAttribute('disabled', 'disabled');

							btnDownloadAsFile.setAttribute('disabled', 'disabled');
							btnDownloadAsDrive.setAttribute('disabled', 'disabled');

                            window.startTime = new Date() * 1;

                            showSpinner();
							isworking=true;
                        };

                        pc.recorder.onstopped = function(evt) {
							isworking=false;
							clearInterval(gprogresstimer);
                            window.recordingTime = window.startTime - new Date() * 1;
                            
                            if ( evt.guid != curGUID) 
                            {
                                return;
                            }

                            btnStart.innerHTML = 'Start'
                            btnStart.removeAttribute('disabled');

                            btnStop.innerHTML = 'Stopped';
                            btnStop.setAttribute('disabled', 'disabled');

                            btnDownloadRaw.removeAttribute('disabled');
                            btnDownloadWave.removeAttribute('disabled');
                            btnDownloadMP3.removeAttribute('disabled');
                            btnUploadWave.removeAttribute('disabled');
                            btnUploadMP3.removeAttribute('disabled');
                            btnPlayBufferAs.removeAttribute('disabled');

                            elDuration.innerHTML = converttime(pc.recorder.result.duration());
                            hideSpinner();
                        };

                        btnStart.onclick = function() {
							if(checkworking())return;
                            // use session guid to make sure the event is fired for current session
                            curGUID = pc.recorder.start();
                        };

                        btnStop.onclick = function() {
                            pc.recorder.stop();
                        };

                        btnDownloadRaw.onclick = function() {
                            var downloadGuid;
                            pc.recorder.result.ondownloaded = function(obj){
                                if ( downloadGuid != obj.guid ){
                                    return;
                                }

                                hideSpinner();

                                // try to convert it to arraybuffer
                                if ( !window.ArrayBuffer ){
                                    alert('Data is downloaded, However your browser does not support essential APIs for Javascript audio processing, try flash APIs!');
                                    return;
                                }

                                var ab = new ArrayBuffer( obj.data.length );
                                var ui8a = new Uint8Array(ab);

                                for( var i = 0; i < obj.data.length; i++ )
                                {
                                    ui8a[ i ] = obj.data[i];
                                }

                                sharedArrayBuffer= ab;
                                sharedDownloadObject = obj;

                                btnEncodeWave.removeAttribute("disabled");
                                btnDownloadAsFile.removeAttribute('disabled');
								btnDownloadAsDrive.removeAttribute('disabled');
                                btnShowHex.removeAttribute('disabled');
                            };

                            pc.recorder.result.ondownloadfailed = function(obj)
                            {
                                if ( downloadGuid != obj.guid ){
                                    return;
                                }
                                //console.log('downloading failed: ' + obj.message);
                                hideSpinner();
                            };

                            // try to download data
                            downloadGuid = pc.recorder.result.download( );

                            showSpinner();
                        };

                        btnEncodeWave.onclick = function(){
                            // get samples
                            var dv = new DataView( sharedArrayBuffer );
                            var samples = [];
                            var obj = sharedDownloadObject;

                            var cur = 0;
                            while( cur < dv.byteLength )
                            {
                                samples.push(dv.getFloat32(cur));
                                cur+=4;
                            }

                            // convert to wave
                            var wavView = encodeWAV({
                                rate: obj.rate == 44 ? 44100 : 0,
                                channels: obj.channels,
                                samples: samples
                            });

                            sharedArrayBuffer = wavView.buffer;

                            // display it 
                            var ui8a = new Uint8Array( wavView.buffer );
                            var arr = [];
                            
                            for(var i = 0; i < ui8a.length;i++){
                                arr.push(ui8a[i]);
                            }

                            btnPlayBuffer.removeAttribute('disabled');
                            btnShowHex.removeAttribute('disabled');
                            btnDownloadAsFile.removeAttribute('disabled');
							btnDownloadAsDrive.removeAttribute('disabled');
                        };

                        btnDownloadMP3.onclick = function() {
							if(checkworking())return;
                            var downloadGuid;
                            pc.recorder.result.ondownloaded = function(obj){
                                hideSpinner();
								btnDownloadMP3.disabled=false;
								isworking=false;
                                if ( downloadGuid != obj.guid ){
                                    return;
                                }

                                // try to convert it to arraybuffer
                                if ( !window.ArrayBuffer ){
                                    alert('Data is downloaded, However your browser does not support essential APIs for Javascript audio processing, try flash APIs!');
                                    return;
                                }

                                var ab = new ArrayBuffer( obj.data.length );
                                var ui8a = new Uint8Array(ab);

                                for( var i = 0; i < obj.data.length; i++ )
                                {
                                    ui8a[ i ] = obj.data[i];
                                }

                                sharedArrayBuffer = ab;
                                sharedDownloadObject = obj;
								_getid('downinfo').innerHTML='MP3: '+number_format(obj.data.length)+' bytes';

                                btnPlayBuffer.removeAttribute('disabled');
                                btnDownloadAsFile.removeAttribute('disabled');
								btnDownloadAsDrive.removeAttribute('disabled');
                                btnShowHex.removeAttribute('disabled');
                            };
                            pc.recorder.result.ondownloadfailed = function(obj)
                            {
                                if ( downloadGuid != obj.guid ){
                                    return;
                                }
                                //console.log('downloading failed: ' + obj.message);
                                hideSpinner();
                            };

                            // try to download data
                            downloadGuid = pc.recorder.result.download( 'mp3' );							
                            showSpinner();
							btnDownloadMP3.disabled=true;
							isworking=true;
                        };

                        btnShowHex.onclick = function(){
                            var ui8a = new Uint8Array( sharedArrayBuffer );
                            var arr = [];
                            
                            for(var i = 0; i < ui8a.length;i++){
                                arr.push(ui8a[i]);
                            }

                            elViewHex.innerHTML = arr.map(function(el){
                                var ret = el.toString(16);
                                if (ret.length == 1) {
                                    ret = "0"+ret;
                                }
                                return ret;
                            }).join(' ');
                        };

                        btnDownloadWave.onclick = function() {
							if(checkworking())return;
                            var downloadGuid;
                            pc.recorder.result.ondownloaded = function(obj){
                                hideSpinner();
								btnDownloadWave.disabled=false;
								isworking=false;
                                if ( downloadGuid != obj.guid ){
                                    return;
                                }

                                // try to convert it to arraybuffer
                                if ( !window.ArrayBuffer ){
                                    alert('Data is downloaded, However your browser does not support essential APIs for Javascript audio processing, try flash APIs!');
                                    return;
                                }

                                var ab = new ArrayBuffer( obj.data.length );
                                var ui8a = new Uint8Array(ab);

                                for( var i = 0; i < obj.data.length; i++ )
                                {
                                    ui8a[ i ] = obj.data[i];
                                }

                                sharedArrayBuffer = ab;
                                sharedDownloadObject = obj;
								_getid('downinfo').innerHTML='WAV: '+number_format(obj.data.length)+' bytes';

                                btnPlayBuffer.removeAttribute('disabled');
                                btnDownloadAsFile.removeAttribute('disabled');
								btnDownloadAsDrive.removeAttribute('disabled');
                                btnShowHex.removeAttribute('disabled');
                                
                            };
                            pc.recorder.result.ondownloadfailed = function(obj)
                            {
                                if ( downloadGuid != obj.guid ){
                                    return;
                                }
                                //console.log('downloading failed: ' + obj.message);
                                hideSpinner();
                            };


                            // try to download data
							if(pc.recorder.result.duration()>50){
								alert("The length is longer than 50 seconds.");																
								return;
							}
                            downloadGuid = pc.recorder.result.download( 'wave' );
                            showSpinner();
							btnDownloadWave.disabled=true;
							isworking=true;
                        };

                        btnPlayBuffer.onclick = function(){
                            // try to play the audio by using web audio api
                            var AudioContext = webkitAudioContext || mozAudioContext;

                            if ( !AudioContext )
                            {
                                alert('Your browser does not support essential APIs for Javascript audio processing, try flash APIs!');
                                return;
                            }

                            var audioContext = sharedAudioContext || new AudioContext();

                            sharedAudioContext = audioContext ;

                            try{
                                var audioBuffer = audioContext.createBuffer( 
                                    sharedArrayBuffer, sharedDownloadObject.channels.length == 1
                                    // obj.channels.length, obj.length, obj.rate
                                );
                            }
                            catch(ex){
                                console.log(ex)
                            }

                            var source = audioContext.createBufferSource();
                            source.connect(audioContext.destination);
                            source.buffer = audioBuffer;
                            source.start(0);
                        };

						
						btnPlayStop.onclick=function(){
							pc.player.stop();
						};
                        btnPlayBufferAs.onclick = function() {
							if(checkworking())return;
                            pc.player.initialize({});

                            pc.player.onstarted = function(evt){
								isworking=true;
								btnPlayStop.removeAttribute('disabled');
                            };

                            pc.player.onstopped = function(evt){
								isworking=false;
								btnPlayStop.setAttribute('disabled', 'disabled');
                            };
                            var guid = pc.player.start();
                        };

                        btnUploadWave.onclick = function(){
                            var uploadGuid;
                            uploadGuid = pc.recorder.result.upload('wave', './test');
                            pc.recorder.result.onuploaded = function(obj)
                            {
                                if (uploadGuid != obj.guid){
                                    return;
                                }
                                alert('uploaded');
                                hideSpinner();
                            };
                            pc.recorder.result.onuploadfailed = function(obj)
                            {
                                if (uploadGuid != obj.guid){
                                    return;
                                }
                                alert(obj.message);
                                hideSpinner();
                            };
                            showSpinner();
                        };

                        btnUploadMP3.onclick = function(){
                            var uploadGuid;
                            uploadGuid = pc.recorder.result.upload('mp3', './test', { format:'multipart', params: {test: "foobar"}});
                            pc.recorder.result.onuploadinteraction = function(){
                                btnUploadMP3Confirm.removeAttribute('disabled');
                                btnUploadMP3Confirm.onclick = function(){
                                    pc.recorder.result.interact();
                                };
                            };
                            pc.recorder.result.onuploaded = function(obj)
                            {
                                if (uploadGuid != obj.guid){
                                    return;
                                }
                                alert('uploaded');
                                hideSpinner();
                            };
                            pc.recorder.result.onuploadfailed = function(obj)
                            {
                                if (uploadGuid != obj.guid){
                                    return;
                                }
                                alert(obj.message);
                                hideSpinner();
                            };
                            showSpinner();
                        };
						
				forceDownload = function(blob, filename){
					var blobLink=_getid('btn_save2_link');
					blobLink.href='javascript:void(0);';
					if(navigator.msSaveBlob){
						navigator.msSaveBlob(blob, filename);
					}else{
						if(!window.URL){
							alert("This browser does not support.");
							return;
						}
						blobLink.download = filename;
						if(glastbloburl) window.URL.revokeObjectURL(glastbloburl);
						glastbloburl=window.URL.createObjectURL(blob);
						if(issafari){
							window.open(glastbloburl);
						}else{
							blobLink.target='_blank';
							blobLink.href=glastbloburl;
						}
					}
				}
						function _save(gdrive){
							var blobLink=_getid('btn_save2_link');
							blobLink.href='javascript:void(0);';
							if(checkworking())return;

                            var dv = new DataView(sharedArrayBuffer);
                            var type = 'audio/wav';					
							var filename='My Audio Recording';
							filename+=' '+datetimetostring(new Date(),true)+'.wav';		
                            if ( dv.getUint8(0) == 255 ) {
                                type = 'audio/mp3';
								var filename='My Audio Recording';
								filename+=' '+datetimetostring(new Date(),true)+'.mp3';		
                            }

							var blob=new Blob([ sharedArrayBuffer ], { type: type} );
							if(gdrive){
								if(!window.FileReader){
									alert("This browser does not support.");
									return;
								}
								var reader = new window.FileReader();
								if(!reader.readAsDataURL){
									alert("This browser does not support.");
									return;
								}
								reader.readAsDataURL(blob); 
								reader.onloadend = function() {
									var strData = reader.result;
                                  					if(gresp && gresp.mimeType!=type) gresp=null;                                  
									proc_save(0, gresp, type, strData.substr(strData.indexOf(",")+1,strData.length), filename);
								}								
							}else{
								forceDownload(blob, filename );
							}
						}
						btnDownloadAsDrive.onclick=function(){
							_save(true);							
						};
                        btnDownloadAsFile.onclick = function() {
							_save(false);
                        };
                        
                        // update the recorder volume
                        ;(function looper(){
                            elVolume.innerHTML = pc.recorder.activity();
                            setTimeout( looper, 200 );
                        })();

                    };
                }
            );

        })();


function proc_save(fileIdx, resp, strMime, strData, strFilename){
	if(!gd_issupported){
		alert("This browser does not support.");
		return;
	}
	if(!gd_loaded || !gd_pickerloaded){
		alert('Not loaded library. Please try again in a few minutes.');
		return;
	}
	if(gd_isdownloading){
		alert("It's working. Please try again later. or Cancel the current job.");
		return;
	}
	function getok(){
		var data2={};
		data2.fileIdx=fileIdx;
		data2.resp=resp;
		data2.data=strData;
		data2.contentType=strMime;
		data2.filename=strFilename;
		
		var a=_getid("gd_savewindow");
		//a.style.left="2px";
		//a.style.top="2px";
		a.style.display='';
		gd_btn_login2();

		var gc_filename=_getid("gc_filename");
		var gc_mimetype=_getid("gc_mimetype");
		var gc_targetfolder=_getid("gc_targetfolder");
		var gc_save=_getid("gc_save");
		var gc_usesaveas=_getid("gc_usesaveas");
		var gc_saveas=_getid("gc_saveas");
		var gc_selectfolder=_getid("gc_selectfolder");
		var gc_resetfolder=_getid("gc_resetfolder");
		var gc_usesaveas2=_getid("gc_usesaveas2");
		var s=getstorage("c_folder");
		var c={};
		try{c=JSON.parse(s);}catch(err){}
		gc_mimetype.innerHTML=strMime;

		function set_save(){
			gc_filename.value=data2.resp.title;
			gc_filename.disabled=true;
			s='';
			if(data2.resp && data2.resp.parents && data2.resp.parents[0] && data2.resp.parents[0].id){
				s='<a href="'+gd_weburl()+'#folders/'+data2.resp.parents[0].id+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+data2.resp.parents[0].id+'">Folder of this file</a>';
			}
			gc_targetfolder.innerHTML=s;

			gc_save.disabled=false;
			gc_usesaveas.style.display='';
			gc_saveas.disabled=true;
			gc_selectfolder.disabled=true;			
			gc_resetfolder.disabled=true;			
		}
		function set_saveas(){
			gc_filename.value=data2.filename || (data2.resp && data2.resp.title) || getstorage('c_last_title') || '';
			gc_filename.disabled=false;

			if(c && c.folderid) s='<a href="'+gd_weburl()+'#folders/'+c.folderid+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+c.folderid+'">'+henc(c.name || 'No Name')+'</a>';
			else s='Folder is not specified.';
			gc_targetfolder.innerHTML=s;

			gc_save.disabled=true;
			gc_saveas.disabled=false;
			gc_selectfolder.disabled=false;
			gc_resetfolder.disabled=false;			
		}

		gc_usesaveas2.checked=false;
		if(data2.resp){
			set_save();
			gc_usesaveas.style.display='';
		}else{
			set_saveas();
			gc_usesaveas.style.display='none';
		}

		gc_usesaveas2.onclick=function(){
			if(this.checked){
				set_saveas();
			}else{
				set_save();
			}
		}
		gc_save.onclick=function(){
			if(!data2.resp.mimeType)data2.resp.mimeType='';
			var s=data2.resp.mimeType.toLowerCase();
			if(s.indexOf('mp3')<0 && s.indexOf('wav')<0 && s.indexOf('wave')<0){
				for(var i=1; i <= 2; i++){    
					var answer=confirm('Type of this file: "'+data2.resp.mimeType+'"\n\nWarning, This file may not be mp3, wave type file. Would you like to overwrite it? ['+i+'/2]');
					if(!answer)return;
				}
			}
			a.style.display='none';              
			proc_update(data2);
		}
		gc_saveas.onclick=function(){
			if(!trim(gc_filename.value)){
				alert('Please enter a filename.');
				gc_filename.focus();
				return;
			}			
			a.style.display='none';             
			var s=getstorage("c_folder");
			var c={};
			try{c=JSON.parse(s);}catch(err){}
			proc_insert(data2, c.folderid);			
		}
	}
	gd_login(function(result){
		if(!result) return;
		getok();
	});
}

function gd_upload(method,boundary,body,path,param,callback){		
	function error(s){
		var result={};
		result.error={"message":s};
		callback(result);
	}
	var access_token=gapi.auth.getToken().access_token;
	if(!access_token){
		error('Error!! No access token.');
		return;
	}

	_getid("downlink2").innerHTML="<table><tr><td><a href='#' id='gd_cancel' style='font-size:14px;display:none'>Cancel</a>&nbsp;<td><div id='gd_progress'>Uploading...</div></table>";
	try{
		var xhr = new XMLHttpRequest();
		var c=_getid('gd_cancel');
		if(c){
			c.style.display='';
			c.onclick=function(){
				xhr.abort(); 
				error('Canceled by user.');
				return false;
			}
		}
		xhr.open(method, 'https://www.googleapis.com'+path+'?'+param, true);
		xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
		xhr.setRequestHeader('Content-Type', 'multipart/mixed; boundary="' + boundary + '"');		
		gd_lastprogress=(new Date()).getTime();
		if(xhr.upload){
			xhr.upload.onprogress=function(event){
				if(gd_lastprogress){
					var elaspetime = new Date();
					var dt=(elaspetime.getTime()-gd_lastprogress)/1000;
					if(dt<1)return;
					gd_lastprogress=elaspetime.getTime();
				}
				var a=event;
				var total=a.totalSize || a.total || 0;
				var current=a.position || a.loaded  || 0;
				var b=_getid("gd_progress");
				if(b) b.innerHTML='&nbsp;Uploading... ('+number_format(current)+'/'+number_format(total)+')';
			};
		}
	    xhr.onload = function(){
			if(this.status == 200){
				var result;
				try{
					result=JSON.parse(this.response);
				}catch(err){
					result='';				
				}
				if(result) callback(result);
				else error('Results value error');				
			}else{
				var s="Error (status) " + this.status + "("+this.statusText+") occurred while uploading the file. or Check the target folder.";
				error(s);
			}
		};
		xhr.onerror = function(e){      
			var s="Error " + e.target.status + " occurred while uploading the file.";
			error(s);
		};
		xhr.send(body); 	
	}catch(err){
		error(err+'\n\nor This browser does not support. Please upgrade your browser.');
	}
}
function proc_insert(data, folderid){
	var title=trim(gc_filename.value);
	go();

function go(){
	if(!title)return;	
  	setstorage('c_last_title',title);
  
	function insertFile2(callback){
		var boundary = '-------314159265358979323846';
        var delimiter = "\r\n--" + boundary + "\r\n";
        var close_delim = "\r\n--" + boundary + "--";

          var contentType = data.contentType;
          var metadata = {
            'title': title,
            'mimeType': contentType
          };
		if(!folderid){
			if(data.resp && data.resp.parents && data.resp.parents[0] && data.resp.parents[0].id) 
				folderid=data.resp.parents[0].id;
		}
		if(folderid) metadata.parents=[{"id":folderid}];

          var multipartRequestBody =
              delimiter +
              'Content-Type: application/json\r\n\r\n' +
              JSON.stringify(metadata) +
              delimiter +
              'Content-Type: ' + contentType + '\r\n' +
              'Content-Transfer-Encoding: base64\r\n' +
              '\r\n' +
              data.data +
              close_delim;
		gd_upload('POST',boundary,multipartRequestBody,'/upload/drive/v2/files/','uploadType=multipart&convert=false',callback);
	}
	
	gd_startsave();
	insertFile2(function(result){
		gd_endsave();
		if(result.error || !result.downloadUrl){
			var s='Error. ';
			_getid("downlink2").innerHTML='&nbsp;<font style="color:green">'+s+'</font>';
			if(result.error){
				if(result.error.message) s+=result.error.message+' ';
				if(result.error.code==401){
					s+='Login or Authorize Error.';
				}
			}
			alert(s);
		}else if(result.downloadUrl){
          		gresp=result;
			gd_saveok(data, result);
		}		
	});
}
}

function proc_update(data){

function updateFile2(callback) {
  var boundary = '-------314159265358979323846';
  var delimiter = "\r\n--" + boundary + "\r\n";
  var close_delim = "\r\n--" + boundary + "--";

    var contentType = data.contentType;
	var resp2=JSON.parse(JSON.stringify(data.resp));
	resp2.mimeType=contentType;

	var multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(resp2) +
        delimiter +
        'Content-Type: ' + contentType + '\r\n' +
        'Content-Transfer-Encoding: base64\r\n' +
        '\r\n' +
        data.data +
        close_delim;
	gd_upload('PUT',boundary,multipartRequestBody,'/upload/drive/v2/files/'+data.resp.id,'uploadType=multipart&alt=json&convert=false',callback);
}
	gd_startsave();
	updateFile2(function(result){
		gd_endsave();
		if(result.error || !result.downloadUrl){
			var s='Error. ';
			_getid("downlink2").innerHTML='&nbsp;<font style="color:green">'+s+'</font>';
			if(result.error){
				if(result.error.message) s+=result.error.message+' ';
				if(result.error.code==401){
					s+='Login or Authorize Error.';
				}else if(result.error.code==500){ //not exist
				}
			}
			alert(s);
		}else if(result.downloadUrl){
			data.resp.mimeType=result.mimeType;
			gd_saveok(data, result);			
		}							
	});
}
function set_img_title(name,result){
	var s=henc(name || '')+getsize(result.fileSize);
	if(result && result.parents && result.parents[0] && result.parents[0].id){
		var link=result.alternateLink || result.webContentLink;
		if(link) s='<a href="'+link+'" target="_blank" title="View on the Google Drive, '+henc(result.mimeType)+'">'+s+'</a>';
		s='<a href="'+gd_weburl()+'#folders/'+result.parents[0].id+'" onclick="gd_clickweburl(this)" target="_blank" title="Show Folder, Folder ID: '+result.parents[0].id+'">Folder</a>,&nbsp; '+s;	
	}
	_getid('img_title').innerHTML=s;
}
function gd_startsave(){
	gd_isdownloading=true;
	//_getid('btn_open').disabled=true;
	//_getid('btn_gsave').disabled=true;
	_getid("downlink2").innerHTML="<table><tr><td><img src='images/wait.gif' align='absmiddle'><td><div id='gd_progress'>Saving...</div></table>";
}
function gd_endsave(){
	gd_isdownloading=false;
	//_getid('btn_open').disabled=false;
	//_getid('btn_gsave').disabled=false;
}
function gd_saveok(data, result){
	var s='&nbsp;<font style="color:green">Save completed.</font>';
	if(result && result.parents && result.parents[0] && result.parents[0].id){
		s+=' &nbsp;<a href="'+gd_weburl()+'#folders/'+result.parents[0].id+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+result.parents[0].id+'">Folder</a>';
		var link=result.alternateLink || result.webContentLink;
		if(link) s+=' &nbsp;<a href="'+link+'" target="_blank" title="View on the Google Drive">View</a>';
		s+=' &nbsp;<a href="#" onclick="proc_delete(\''+result.id+'\',this);return false" data="'+escape(result.title || '')+'" title="Delete this file">Delete</a>';
	}
	_getid("downlink2").innerHTML='<table><tr><td>'+s+'</table>';
}
function proc_delete(fileId,f){
	//var answer=confirm("Do you want to delete a file permanently?");
	//if(!answer)return;
	function proc_log(s){
		var a=_getid("downlink2");
		a.innerHTML='<table><tr><td>'+s+'</table>';
	}
function go(){
	proc_log('<font class=welcome>Deleting...</font>');
	var request = gapi.client.drive.files['delete']({
		'fileId': fileId
	});
	request.execute(function(resp){
		if(resp.result && !resp.message){
			proc_log('<font class=processed>Delete completed. '+henc(unescape(f.getAttribute('data')))+'</font>');
          gresp=null;
		}else{
			proc_log('<font class=processed>Delete failed. <font color=green>'+resp.message+'</font> '+henc(unescape(f.getAttribute('data')))+'</font>');
		}
	});
}
	gapi.client.load('drive', 'v2', function(){
		go();
	});
}
    </script>

<style>
a.bottomlink:link{text-decoration:underline;}
a.bottomlink:visited{text-decoration:underline;}
a.bottomlink:active{text-decoration:underline;}
a.bottomlink:hover{text-decoration:underline;}
</style>

<table id="bottomtable" align=center>
<tr><td height=7>
<tr><td align=center><span id="bottomtitle">â“’ Cloud Audio Recorder, 2015</span>
	</table><br>

<div id="gd_savewindow" class="gd_div" style="z-index:100;display:none;padding:10px">
<table style="white-space:nowrap">
<tr><td>Filename<td><input type=text id="gc_filename" style="width:350px">
<tr><td>Save Type&nbsp;<td><div id="gc_mimetype" style="width:350px"></div>
<tr><td>Target Folder&nbsp;<td><div id="gc_targetfolder" style="width:350px;white-space:nowrap;overflow:hidden"></div>
<tr><td>
<tr><td colspan=2 align=center>
	<button id="gc_save" style="font-weight:bold" class=middle title="Save">Save</button> <label id="gc_usesaveas"><input type=checkbox id="gc_usesaveas2">Use Save as</label> <button id="gc_saveas" title="Save as.." style="font-weight:bold" class=middle>Save as..</button> <button id="gc_selectfolder" onclick="gd_open_picker(2)">Select Folder</button> <button id="gc_resetfolder" onclick="proc_setfolder('','')" title="Folder is not specified.">Reset</button>
<tr><td>
<tr><td colspan=2 align=center>
	<button onclick="_getid('gd_savewindow').style.display='none';"><img src="images/close.png" align="absmiddle"> Close</button>
</table>
</div>

<style>
.gd_div{background-color:#FFFFE1;position:absolute;overflow:hidden;-webkit-box-shadow: 0 0 25px #999;-moz-box-shadow: 0 0 25px #999;box-shadow: 0 0 25px #999;}
</style>
<div id="layer_message" class="gd_div" style="z-index:10001;display:none;"></div>
<div id="gd_window" class="gd_div" style="z-index:10000001;display:none;"></div>
<div id="gd_btn_login" class="gd_div" style="z-index:10000000;display:none;">
<table>
<tr><td align=center><button onclick="gd_login_manual()" style="font-size:20px"><img src="images/gdrive/product20.png" align="absmiddle"> Login & Authorize</button> <button onclick="gd_login_close()" style="font-size:20px">Close</button>
<tr><td>To use this app, Please login to the Google Drive and authorize this app or website.
<br>(Note: If your browser block or disable the third-party cookies, this login does not work correctly.)
</table>
</div>
<script>
var CLIENT_ID = '16125005200-airk6hk1ldh4hk7t8vd8kl9f3anf3im4.apps.googleusercontent.com';
var SCOPES = [
	'https://www.googleapis.com/auth/drive.install',
	'https://www.googleapis.com/auth/drive'
];
var gd_developerKey='AIzaSyCOtLnD_2BwAstFMduLKiE7t1ka28JIF5Q';
var gd_mimetype="image/png,image/jpeg,image/jpg,image/gif,application/vnd.google-apps.drawing,image/x-icon,image/bmp";
var gd_export_extension=["png"];
var gd_state='';

var gd_picker,gd_picker2,gd_loaded,gd_pickerloaded,gd_lastprogress,gd_issupported,gd_isdownloading,gd_load_timer,gd_bloburl,gd_state2;
var gd_loginexp=0;
var gd_callback;
var ismsie=false;
if(navigator.appName!="Netscape"){
	if(navigator.userAgent.indexOf("MSIE")>=0) ismsie=true;
}

function gd_btn_login2(e,callback){
	function go(a){
		if(a && a.style.display==''){
			var x=getScrollLeft()+((getWindowWidth()-a.clientWidth) / 2);
			var y=getScrollTop()+((getWindowHeight()-a.clientHeight) / 2);
			a.style["border"]="1px solid #000000";
			a.style["padding"]="10px";
			a.style.left=x+"px";
			a.style.top=y+"px";
		}
	}
	go(_getid("gd_btn_login"));
	go(_getid("gd_window"));	
	go(_getid("gd_savewindow"));		
	setTimeout(function(){
		go(_getid("gd_btn_login"));
		go(_getid("gd_window"));	
		go(_getid("gd_savewindow"));	
		if(callback)callback();
	},10);
}
function gd_btn_login(isshow){
	var a=_getid("gd_btn_login");
	if(isshow){
		a.style.display='';
		gd_btn_login2();
	}else{
		a.style.display='none';
	}
}
function gd_login_close(){
	gd_btn_login(false);
	_getid("downlink").innerHTML='';
  	gd_state='';
}
function gd_login_manual(){
	var p={'client_id': CLIENT_ID, 'scope': SCOPES.join(' '), 'immediate': false};
	if(gd_userId){p['login_hint']=gd_userId;p['authuser']=-1;} 
	gapi.auth.authorize(p, function (authResult){ 
		if (authResult && !authResult.error){
			gd_loginexp=(new Date()).getTime()+parseInt(authResult.expires_in*0.7*1000);
			gd_btn_login(false);gd_info();
			show_message("Login ok!!");
			if(gd_callback) gd_callback(true);
			else gd_open_state(true);
		}else{
			gd_btn_login(true);
			show_message("Login failed!!");
		}
	});
}
function gd_login(callback,react){
	if(gd_loginexp==0 || gd_loginexp<(new Date()).getTime()){
	}else{
		callback(true);
		return;
	}
	var p={'client_id': CLIENT_ID, 'scope': SCOPES.join(' '), 'immediate': true};
	if(gd_userId){p['login_hint']=gd_userId;p['authuser']=-1;}
	gapi.auth.authorize(p, function (authResult){
		if (authResult && !authResult.error){
			gd_loginexp=(new Date()).getTime()+parseInt(authResult.expires_in*0.7*1000);
			gd_btn_login(false);gd_info();
			callback(true);
		}else{
			show_message("Login failed!!");
			gd_btn_login(true);
			callback(false);
			if(react) gd_callback=callback;
			else gd_callback=null;
		}
	});
}

function gd_loadpicker() {		
	gapi.load('picker',{'callback': function(){
			gd_pickerloaded=true;
		}
	});	
}
function proc_setfolder(id,name){
	var c={};
	c.folderid=id;
	c.name=name;
	var s;
	if(c.folderid) s='<a href="'+gd_weburl()+'#folders/'+c.folderid+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+c.folderid+'">'+henc(c.name || 'No Name')+'</a>';
	else s='Folder is not specified.';
	_getid('gc_targetfolder').innerHTML=s;	
	if(window.JSON) setstorage("c_folder",JSON.stringify(c));
}
function gd_createpicker(kind) {
	function gd_pickercallback(data) {
		if (data.action == google.picker.Action.PICKED) {
			if(data.docs && data.docs.length>0 && data.docs[0].id){
				if(!kind){
					gd_loadfiles(data.docs);
				}else if(kind==2){
					if(data.docs[0].type!="folder"){
						alert("It's not a folder.");
						return;
					}
					proc_setfolder(data.docs[0].id, data.docs[0].name);
				}
			}
		}
	}
	var access_token=gapi.auth.getToken().access_token;
	if(!access_token){
		alert('Error!! No access token.');
		return;
	}
	if(!kind){
	 if(!gd_picker){
	  var view2 = new google.picker.DocsView(google.picker.ViewId.DOCS);
	  if(gd_mimetype) view2.setMimeTypes(gd_mimetype);
	  view2.setMode(google.picker.DocsViewMode.LIST);

		var view4 = new google.picker.DocsView();
		view4.setIncludeFolders(true);
		view4.setParent("root");
		view4.setMimeTypes(gd_mimetype);
		var view5 = new google.picker.View(google.picker.ViewId.RECENTLY_PICKED);

      gd_picker = new google.picker.PickerBuilder()
		  //.enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
		  .setLocale("en") //window.navigator.language || window.navigator.userLanguage || "en"
          .setOAuthToken(access_token)
		  .setTitle("Select a Image file")
          .addView(view2)
		  .addView(view4)
		  .addView(view5)
          .addView(new google.picker.DocsUploadView())
          .setDeveloperKey(gd_developerKey)
          .setCallback(gd_pickercallback)
          .build();
	 }
	 gd_picker.setVisible(true);
	}else if(kind==2){
	  if(!gd_picker2){
		var docsView = new google.picker.DocsView()
          .setIncludeFolders(true) 
		  .setParent("root")
          .setMimeTypes('application/vnd.google-apps.folder')
          .setSelectFolderEnabled(true);
		var view5 = new google.picker.View(google.picker.ViewId.RECENTLY_PICKED);

        gd_picker2 = new google.picker.PickerBuilder()
		  .setLocale("en") 
          .setOAuthToken(access_token)
		  .setDeveloperKey(gd_developerKey)
		  .setTitle("Select a folder to save as..")
          .addView(docsView)
		  .addView(view5)
          .setCallback(gd_pickercallback)
          .build();
	  }
	  gd_picker2.setVisible(true);
	}
}

	function gettitle(resp){
		if(resp.title){
			if(resp.exportLinks) s=resp.title+'.'+resp.fileExtension;
			else s=resp.title;
		}else{
			s='No Name';
		}
		return s;
	}			
	function getsize(fileSize){
		if(!fileSize) return '';
		function humanFileSize(bytes){
			var thresh = 1024;
			if(bytes < thresh) return bytes + ' B';
			var units = ['kB','MB','GB','TB','PB','EB','ZB','YB'];
			var u = -1;
			do {
				bytes /= thresh;
				++u;
			} while(bytes >= thresh);
			return bytes.toFixed(1)+' '+units[u];
		}
		return ' ('+humanFileSize(fileSize)+')';
	}	
	function setdown(resp,url){
		_getid("downlink").innerHTML='';
		if(!resp)return;
		if(!url){
			if(resp.downloadUrl){
				url=resp.downloadUrl;
			}else if(resp.exportLinks){
				for (x in resp.exportLinks){	
					for(var i = 0; i < gd_export_extension.length; i++){    
						if(x.toLowerCase().indexOf(gd_export_extension[i])>=0){
							url=resp.exportLinks[x];
							resp.fileExtension=gd_export_extension[i];
							break;
						}						
					}					
					if(url)break;
				}
			}
			if(!url || !gaccessToken) return;
			url=url+'&access_token='+encodeURIComponent(gaccessToken);
		}
		_getid("downlink").innerHTML='<table><tr><td><a id="adownlink" style="font-size:15px">Download the file</a></table>';
		var a=_getid("adownlink");
		if(a){
			a.href=url;
			var s=gettitle(resp);
			a.download=s || "";
			a.title=(s || "")+getsize(resp.fileSize);
			a.target='_blank';
		}
	}

var gaccessToken;
function gd_loadfiles(docs,isstart){
	if(gd_isdownloading){
		alert("It's working. Please try again later. or Cancel the current job.");
		return;
	}
	function end(){
		gd_isdownloading=false;
	}
	function go(idx){
		if(idx>docs.length-1){
			end();return;
		}
		function next(){
			//idx++;
			//go(idx);
			end();
		}
		if(docs[idx].id){
			gd_loadfile(docs[idx].id,docs.length,idx+1,function(){
				next();
			});
		}else{
			next();
		}
	}
	gapi.client.load('drive', 'v2', function(){
		gd_isdownloading=true;
		go(0);
	});
}
function gd_loadfile(fileId,total,currentidx,callback){
	var prefix='['+currentidx+'/'+total+'] ';
	_getid("downlink").innerHTML="<table><tr><td><div id='gd_progress'>"+prefix+"Ready...</div></table>";

	function go(){
		var request = gapi.client.drive.files.get({
			'fileId': fileId
		});
		request.execute(function(resp){
			function end(abort){
				clearTimeout(messagetimer);
				hide_message();
				var a=_getid("downlink");
				if(a.innerHTML && a.innerHTML.indexOf("adownlink")<0){
					_getid("downlink").innerHTML='';
				}
				if(!abort && callback) callback();
				else gd_isdownloading=false;
			}
			function error(s){				
				if(resp) s=gettitle(resp)+getsize(resp.fileSize)+'\n\n'+s;
				alert(prefix+s);
			}
			//console.log(resp);

			var downloadurl;
			if(resp.downloadUrl){
				downloadurl=resp.downloadUrl;
				go();
			}else if(resp.exportLinks){
				for (x in resp.exportLinks){	
					for(var i = 0; i < gd_export_extension.length; i++){    
						if(x.toLowerCase().indexOf(gd_export_extension[i])>=0){
							downloadurl=resp.exportLinks[x];
							resp.fileExtension=gd_export_extension[i];
							break;
						}						
					}					
					if(downloadurl)break;
				}
				go();
			}else{go();}

		  function go(){
			var accessToken = gapi.auth.getToken().access_token;
			if(!accessToken){
				end();
				alert('Error!! No access token.');
				return;
			}
			if(downloadurl){				
					function getsize(){
						function humanFileSize(bytes){
							var thresh = 1024;
							if(bytes < thresh) return bytes + ' B';
							var units = ['kB','MB','GB','TB','PB','EB','ZB','YB'];
							var u = -1;
							do {
								bytes /= thresh;
								++u;
							} while(bytes >= thresh);
							return bytes.toFixed(1)+' '+units[u];
						}
						var s;
						if(!resp.fileSize) s=' (Unknown Size)';
						else s=' ('+humanFileSize(resp.fileSize)+')';
						return s;
					}					
					function setdown(url){
						var s,s1;
						if(resp.title){
							s=resp.title || '';
							s1=resp.title || '';
						}else{
							s='No Name';
							s1=s;
						}
						//if(fromstate) proc_setvalue(s);
						
						var vlink='';
						if(resp.alternateLink || resp.webContentLink) vlink='<a href="'+(resp.alternateLink || resp.webContentLink)+'" target="_blank" title="View or Edit on Google Drive">View or Edit</a>&nbsp; ';
						if(resp.exportLinks){
							var prefer=getstorage('c_prefer_ext');
							s='<select id="adownsel" style="width:500px;margin-bottom:1px">';
							for(var i = 0; i < gexportlist.length; i++){
								s+='<option value="'+i+'"';
								if(gexportlist[i].ext){
									if(gexportlist[i].ext==prefer) s+=' selected';
									s+='>(.'+gexportlist[i].ext+') ';
								}else{
									s+='>';
								}
								s+=gexportlist[i].name;
							}		
							s+='</select><br><a id="adownlink" style="font-size:19px;display:none">Download this file</a>&nbsp; '+vlink+'<a href="#" onclick="gd_msgclear();return false;">Close</a> &nbsp;Export from Google document format.';
							_getid("downlink").innerHTML=s;
							var a=_getid("adownsel");
							if(a){
								a.onchange=function(){
									if(!this.value)return;
									var d=gexportlist[this.value];
									if(!d)return;
									setstorage('c_prefer_ext',d.ext);
									var a=_getid("adownlink");
									if(a){
										a.href=d.url;
										var s=d.title || '';
										if(d.ext) s+='.'+d.ext;
										a.download=s;
										a.title=s;
										a.style.display='';
										_getid("msg").innerHTML=html_entity_encode(s);
									}
								}
								a.onchange();
							}
							return;
						}

						_getid("downlink").innerHTML='<a id="adownlink" style="font-size:19px">Download this file</a>'+getsize()+'&nbsp; '+vlink+'<a href="#" onclick="gd_msgclear();return false;">Close</a> '+"";
						var a=_getid("adownlink");
						if(a){
							a.href=url;
							a.download=s;
							a.title=s;
							_getid("msg").innerHTML=html_entity_encode(s);
						}
					}

					gd_isdownloading=true;
					_getid("downlink").innerHTML="<table><tr><td><img src='images/wait.gif' align='absmiddle'><td><div id='gd_progress'>Downloading...</div></table>";
					setTimeout(function(){
						end();
						if(resp.exportLinks){
							setdown();
						}else{
							setdown(downloadurl+'&access_token='+encodeURIComponent(accessToken));					
						}
					},300);
			}else{
				end();
				if(resp.error && resp.error.message){
					alert(resp.error.message);
				}else{
					alert('Error!! Can not find a download URL.');
				}
			}
		  }
		});
	}
	go();
}
function gd_open_picker(kind){
	if(!gd_issupported){
		alert("This browser does not support.");
		return;
	}
	if(!gd_loaded || !gd_pickerloaded){
		if(!gd_load_timer) gd_loadscript(function(){gd_open_picker(kind);});
		else alert('Not loaded library. Please try again in a few minutes.');
		return;
	}
	gd_login(function(result){
		if(!result) return;
		gd_createpicker(kind);
	},true);
}

function gd_getparam(s,name){
	name=name+"=";
	name=name.toLowerCase();
	var p1=s.toLowerCase().indexOf(name);
	if (p1<0) return "";
	s=s.substr(p1+name.length);
	var p2=s.toLowerCase().indexOf("&");
	if (p2>=0) {
		return s.substr(0,p2);
	} else {
		return s;
	}
}
function gd_open_state(force){
	var s=gd_state;
	if(s){
		if(!gd_issupported){
			gd_state='';
			alert("This browser does not support.");
			return;
		}
		s=decodeURIComponent(s);
		try{
			var a=JSON.parse(s);
			var ids=[];
			function find(b){
				if(!b)return;
				for(var i=0; i <= b.length-1; i++){
					if(b[i]){
						var cc={};
						cc.id=b[i];
						ids.push(cc);
					}
				}
			}
			find(a.ids);
			find(a.exportIds);
			if(ids.length>0){
				gd_login(function(result){
					if(gd_open2 && !force)return;
					gd_open2=true;                  
					if(!result)return;				
					//_getid('gd_btn_reopen').style.display='';
					gd_state='';
					gd_loadfiles(ids,true);
				});				
			}
		}catch(err){
		}
	}
}
function gd_clientload(){
	gd_loaded=true;
	if (window.addEventListener){
		window.addEventListener("resize", gd_btn_login2, false);
	}else if (window.attachEvent){
		window.attachEvent("onresize", gd_btn_login2);
	}
	gd_open_state();
}
var gd_open2;
function gd_open_state2(){
	setTimeout(function(){
		if(!gd_open2)gd_open_state();
	}, 1000);
}

function gd_loadscript(callback){
	function inject(s){
		var o = document.createElement('scri' + 'pt');
		o.setAttribute('src', s);
		o.setAttribute('type', 'text/javascript');
		document.body.appendChild(o);
	}
	if(gd_load_timer)return;
	if(gd_loaded && gd_pickerloaded)return;
	gd_load_timer=setInterval(function(){
		if(gd_loaded && gd_pickerloaded){
			clearInterval(gd_load_timer);
			if(callback) callback();
		}
	},100);
	inject('https://apis.google.com/js/client.js?onload=gd_clientload');
	inject('https://apis.google.com/js/api.js?onload=gd_loadpicker');	
}
function gd_reopen(){
	if(gd_state2){
		var m="";
		var s='?';
		if(m) s+='m='+m+'&';
		s+='state='+encodeURIComponent(gd_state2);
		location.href=s;
	}
}
function gd_dblclick(){
	function dblclick(){
		try{
			if(gd_picker)gd_picker.setVisible(false);
			if(gd_picker2)gd_picker2.setVisible(false);
		}catch(err){}
	}
	function keydown(e){
		if(!e)e=window.event;
		if(e && e.keyCode==27) dblclick();
	}
	if(window.addEventListener){
		document.addEventListener("dblclick", dblclick, false);
		document.addEventListener("keydown", keydown, false);
	}else if(window.attachEvent){
		document.attachEvent("ondblclick", dblclick);
		document.attachEvent("onkeydown", keydown);
	}
}
var gd_userId,gd_email;
function gd_weburl(){
	var s;
	if(gd_email) s='https://drive.google.com/?authuser='+encodeURIComponent(gd_email);
	else s='https://drive.google.com/';
	return s;
}
function gd_clickweburl(f){
	var s=f.href || '';
	var p1=s.indexOf('#');
	if(p1<0) s='';
	else s=s.substr(p1,s.length);
	f.href=gd_weburl()+s;
}  
function gd_info(){
	if(gd_email)return;
	gapi.client.load('drive', 'v2', function(){
		var request = gapi.client.drive.about.get();
		request.execute(function(resp) {
			if(resp && resp.user){
				if(gd_email)return;
				gd_email=resp.user.emailAddress;
				if(gd_email){
					var a=_getid('gc_save');
					var b=_getid('gc_saveas');
                  			var c=_getid('mic-buffer-drive');
					if(a)a.title=a.title+' ('+gd_email+')';
					if(b)b.title=b.title+' ('+gd_email+')';
                  			if(c)c.title=c.title+' ('+gd_email+')';
				}				
			}
		});
	});
}  
function gd_init(){
	gd_state=gd_getparam(location.href,'state');
	if(gd_state) gd_state=decodeURIComponent(gd_state);

	gd_dblclick();
	gd_state2=gd_state;
	if(!window.XMLHttpRequest || !window.FileReader){		
	}else{
		gd_issupported=true;
		if(gd_state){
			try{
				var a=JSON.parse(gd_state);
				gd_userId=a.userId;              
				if(a.ids || a.exportIds){
					_getid("downlink").innerHTML="<table><tr><td><div id='gd_progress'>Ready...</div></table>";
				}
			}catch(err){}			
			if(window.addEventListener) window.addEventListener("load", gd_open_state2, false);
			else if (window.attachEvent) window.attachEvent("onload", gd_open_state2);          
		}
		gd_loadscript();
	}
}
gd_init();

function gd_msgclear(){
	_getid("downlink").innerHTML='';
	_getid("msg").innerHTML='';
}
</script>

</body>
</html>